# セキュリティ実装ガイド

長瀬サロンWebサイトのセキュリティ実装について説明します。

## 実装済みのセキュリティ対策

### 1. セキュリティヘッダー（middleware.ts）

以下のセキュリティヘッダーを全てのレスポンスに設定しています：

- **X-XSS-Protection**: XSS攻撃の検出と防止
- **X-Content-Type-Options**: MIMEタイプのスニッフィング防止
- **X-Frame-Options**: クリックジャッキング攻撃の防止
- **Referrer-Policy**: リファラー情報の制御
- **Strict-Transport-Security**: HTTPS通信の強制
- **Permissions-Policy**: ブラウザ機能の使用制限
- **Content-Security-Policy (CSP)**: コンテンツの読み込み元を制限

### 2. CSRF対策（csrf.ts）

Cross-Site Request Forgery攻撃を防ぐため、以下を実装：

- **CSRFトークン生成・検証**: セキュアなランダムトークン
- **ワンタイムトークン**: トークンの再利用防止
- **セッション連携**: セッションIDとトークンの関連付け
- **自動期限切れ**: トークンの有効期限管理

### 3. セッション管理（session-manager.ts）

高度なセッション管理機能：

- **セッションタイムアウト**: アイドル時間とmax age制御
- **セッションハイジャック対策**: IP・User-Agent検証
- **セッション更新**: 定期的なセッションID更新
- **管理者セッション**: より厳格な設定（30分タイムアウト）

### 4. セキュア認証（secure-auth.ts）

認証システムの強化：

- **ブルートフォース攻撃対策**: ログイン試行回数制限
- **パスワード強度チェック**: 複雑性要件の強制
- **アカウントロックアウト**: 異常なログイン試行の検出
- **セキュリティログ**: 認証イベントの記録

### 5. APIセキュリティ（api-security.ts）

API保護機能：

- **APIキー認証**: アクセス制御と権限管理
- **リクエスト署名**: メッセージ完全性の検証
- **IPホワイトリスト**: 管理者APIのアクセス制限
- **ペイロード検証**: 入力データのサニタイゼーション

### 6. XSS保護（xss-protection.ts）

包括的なクロスサイトスクリプティング対策：

- **DOMPurify統合**: HTMLサニタイゼーション
- **URLサニタイゼーション**: 悪意のあるURL検出
- **CSSサニタイゼーション**: スタイル注入防止
- **XSS攻撃パターン検出**: 自動脅威検知

### 7. セキュリティログ（security-logger.ts）

セキュリティイベントの監視・分析：

- **包括的なログ記録**: 18種類のセキュリティイベント
- **異常検知**: 不審なアクティビティの自動検出
- **リアルタイムアラート**: 脅威の即座な通知
- **セキュリティダッシュボード**: 可視化と分析

### 8. 脆弱性スキャン（security-scanner.ts）

自動セキュリティテスト：

- **OWASP Top 10対応**: 主要脆弱性の検出
- **包括的スキャン**: 15種類の脆弱性タイプ
- **セキュリティスコア**: 0-100のリスク評価
- **推奨事項生成**: 自動改善提案

### 9. APIレート制限（rate-limit.ts）

過度なリクエストを防ぐため、以下のレート制限を実装：

- **一般API**: 1分あたり30リクエスト
- **管理画面API**: 15分あたり100リクエスト
- **予約フォーム**: 1時間あたり5リクエスト（スパム対策）

### 10. 入力値検証（validation.ts）

Zodライブラリを使用した厳格な入力値検証：

- スタイリスト情報の検証
- メニュー情報の検証
- 予約フォームの検証
- ニュース記事の検証
- サロン情報の検証

各フィールドに対して：
- 型チェック
- 長さ制限
- フォーマット検証
- XSS対策のサニタイゼーション

### 11. 環境変数管理

- `.env.local`: 秘密情報の保存
- `.env.example`: 必要な環境変数のテンプレート
- Gitignoreによる秘密情報の除外

## セキュリティベストプラクティス

### 開発時の注意事項

1. **秘密情報の取り扱い**
   - APIキーや認証情報は必ず環境変数に保存
   - `.env.local`ファイルは絶対にコミットしない
   - コード内にハードコードしない

2. **依存関係の管理**
   - 定期的に`npm audit`を実行
   - 脆弱性が見つかったら速やかに修正
   - 不要なパッケージは削除

3. **入力値の処理**
   - 全てのユーザー入力を検証
   - SQLインジェクション対策（S3使用のため低リスク）
   - XSS対策のためのサニタイゼーション

4. **エラーハンドリング**
   - 詳細なエラー情報を外部に漏らさない
   - 本番環境では一般的なエラーメッセージを表示
   - エラーログは適切に管理

### 運用時の推奨事項

1. **定期的なセキュリティチェック**
   - 月1回の`npm audit`実行
   - 四半期ごとの依存関係更新
   - 年1回のセキュリティレビュー

2. **アクセスログの監視**
   - 異常なアクセスパターンの検知
   - レート制限の効果確認
   - 必要に応じて制限値の調整

3. **バックアップとリカバリ**
   - 定期的なデータバックアップ
   - リカバリ手順のテスト
   - インシデント対応計画の策定

## 今後の改善予定

### Phase 2（短期）
- CSRF対策の強化
- セッションタイムアウトの実装
- より詳細なログ記録

### Phase 3（中期）
- Web Application Firewall (WAF) の導入
- DDoS対策の強化
- セキュリティ監視ツールの導入

### Phase 4（長期）
- 2要素認証（2FA）の実装
- IPホワイトリスト機能
- ペネトレーションテストの実施

## 緊急時の対応

セキュリティインシデントが発生した場合：

1. **即座の対応**
   - 影響範囲の特定
   - 必要に応じてサービスの一時停止
   - ログの保全

2. **調査と修正**
   - 原因の特定
   - 脆弱性の修正
   - 再発防止策の実施

3. **報告と改善**
   - インシデントレポートの作成
   - 必要に応じて関係者への報告
   - セキュリティポリシーの見直し

## お問い合わせ

セキュリティに関する質問や脆弱性の報告は、管理者までご連絡ください。